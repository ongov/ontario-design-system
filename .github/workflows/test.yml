name: Test

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: number
      build-artifacts-name:
        required: true
        type: string
    outputs:
      test-run-id:
        description: Reusable workflow run ID for downloading test artefacts.
        value: ${{ jobs.report-context.outputs.run-id }}

jobs:
  stencil-unit-test:
    name: Stencil Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build-artifacts-name }} # Artifact name (must match upload name)
          path: ./packages

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Stencil Unit Tests
        run: pnpm run test:unit

      - name: Upload Stencil Unit JUnit results
        if: ${{ (success() || failure()) }}
        uses: actions/upload-artifact@v4
        with:
          name: stencil-unit-junit-results
          path: packages/ontario-design-system-component-library/junit.xml

  stencil-e2e-test:
    name: Stencil E2E Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.55.0-noble
      options: --user pwuser
    env:
      HOME: /github/home
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - uses: actions/checkout@v4
      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build-artifacts-name }}
          path: ./packages

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Stencil E2E Tests
        run: pnpm run test:e2e:stencil

      - name: Upload Stencil E2E Test Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: stencil-e2e-test-results
          path: packages/ontario-design-system-component-library/test-results

      - name: Upload Stencil E2E JUnit results for GitHub integration
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: stencil-e2e-junit-results
          path: packages/ontario-design-system-component-library/test-results/playwright/results.xml

      - name: Upload Stencil Playwright HTML report
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: stencil-playwright-html-report-e2e
          path: packages/ontario-design-system-component-library/playwright-report

  apps-vrt-test:
    name: Apps VRT Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.55.0-noble
      options: --user pwuser
    env:
      HOME: /github/home
    needs: ['stencil-unit-test', 'stencil-e2e-test']
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - uses: actions/checkout@v4
      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build-artifacts-name }}
          path: ./packages

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run All VRT Tests
        run: pnpm run test:vrt

      - name: Upload Next.js VRT Test Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-vrt-test-results
          path: packages/app-nextjs/test-results

      - name: Upload Next.js VRT JUnit results for GitHub integration
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-vrt-junit-results
          path: packages/app-nextjs/test-results/playwright/results.xml

      - name: Upload Next.js Playwright HTML report
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-playwright-html-report-vrt
          path: packages/app-nextjs/playwright-report

  apps-e2e-test:
    name: Apps E2E Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.55.0-noble
      options: --user pwuser
    env:
      HOME: /github/home
    needs: ['stencil-unit-test', 'stencil-e2e-test']
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - uses: actions/checkout@v4
      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js ${{ inputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.build-artifacts-name }}
          path: ./packages

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run All E2E Apps Tests
        run: pnpm run test:e2e:apps

      - name: Upload Next.js E2E Apps Test Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-e2e-test-results
          path: packages/app-nextjs/test-results

      - name: Upload Next.js E2E Apps JUnit results for GitHub integration
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-e2e-junit-results
          path: packages/app-nextjs/test-results/playwright/results.xml

      - name: Upload Next.js Playwright HTML report
        if: ${{ success() || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-playwright-html-report-e2e
          path: packages/app-nextjs/playwright-report

  report-context:
    name: Report Context
    runs-on: ubuntu-latest
    outputs:
      run-id: ${{ steps.run-id.outputs.run-id }}
    steps:
      - id: run-id
        run: echo "run-id=${{ github.run_id }}" >> "$GITHUB_OUTPUT"
